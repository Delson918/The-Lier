<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <title>The Lier</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 0; 
      background-color: #222;
      color: #eee;
    }
    .page { 
      display: none; 
      padding: 20px; 
      min-height: 100vh;
      box-sizing: border-box;
      position: relative;
    }
    #pageA {
      background-color: #333;
    }
    #pageB {
      background-color: #444;
    }
    .active { display: block; }
    .box { 
      border: 1px solid #666; 
      padding: 15px; 
      margin: 15px 0; 
      background-color: rgba(0,0,0,0.3);
      border-radius: 5px;
    }
    .button { 
      padding: 8px 15px; 
      margin: 5px; 
      background-color: #555;
      color: white;
      border: 1px solid #777;
      border-radius: 3px;
      cursor: pointer;
    }
    .button:hover {
      background-color: #666;
    }
    .button:disabled {
      background-color: #333;
      cursor: not-allowed;
    }
    .topbar { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      border-bottom: 1px solid #666; 
      padding: 10px; 
    }
    .results { 
      height: 200px; 
      overflow-y: auto; 
      border: 1px solid #666; 
      padding: 10px; 
      margin-bottom: 10px; 
      background-color: rgba(0,0,0,0.2);
    }
    .hidden { display: none; }
    .quit-menu { 
      position: absolute; 
      top: 40px; 
      right: 20px; 
      border: 1px solid #666; 
      background: #333; 
      padding: 10px; 
      z-index: 100;
    }
    .input-cards { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .card { 
      width: 40px; 
      height: 60px; 
      border: 1px solid #666; 
      display: inline-block; 
      background-color: rgba(255,255,255,0.1);
      cursor: pointer;
      position: relative;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    .card.selected {
      border: 2px solid gold;
      box-shadow: 0 0 10px gold;
    }
    .card.submitted {
      opacity: 0.5;
      filter: brightness(0.5);
      cursor: not-allowed;
    }
    .result-card {
      display: inline-block;
      width: 30px;
      height: 45px;
      border: 1px solid #666;
      margin: 2px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      background-color: rgba(255,255,255,0.1);
    }
    select, input {
      padding: 5px;
      background-color: #444;
      color: white;
      border: 1px solid #666;
      border-radius: 3px;
    }
    h2, h3 {
      color: #ddd;
    }
    #seedOutput {
      width: 120px;
    }
    .version {
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 12px;
      color: #999;
    }
    .gun-image {
      width: 30px;
      height: 30px;
      vertical-align: middle;
      margin-right: 5px;
    }
    .ammo-section {
      margin-top: 20px;
    }
    .result-row {
      margin: 5px 0;
    }
  </style>
</head>
<body>

<!-- Page A -->
<div id="pageA" class="page active">
  <h2>THE LIER</h2>
  
  <div class="box">
    <h3>Generate seed</h3>
    Number of players:
    <select id="numPlayers" required>
      <option value="" selected disabled>Please Select</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
    </select>
    <button class="button" onclick="generateSeed()">Generate</button><br>
    Seed: <input type="text" id="seedOutput" readonly>
    <button class="button" onclick="copySeed()">Copy</button>
  </div>
  
  <div class="box">
    <h3>Enter the seed</h3>
    Seed: <input type="text" id="seedInput"><br><br>
    I am the 
    <select id="playerNumber" required>
      <option value="" selected disabled>Please Select</option>
      <option value="1">1st</option>
      <option value="2">2nd</option>
      <option value="3">3rd</option>
      <option value="4">4th</option>
      <option value="5">5th</option>
      <option value="6">6th</option>
      <option value="7">7th</option>
      <option value="8">8th</option>
    </select> player
    <br><br>
    <button class="button" onclick="enterGame()">Enter the Game</button>
  </div>
  
  <div class="version">v1.0.1</div>
</div>

<!-- Page B -->
<div id="pageB" class="page">
  <div class="topbar">
    <h2>THE LIER</h2>
    <div>
      <button class="button" onclick="toggleMenu()">...</button>
      <div id="quitMenu" class="quit-menu hidden">
        <button class="button" onclick="quitGame()">Quit the game</button>
      </div>
    </div>
  </div>
  
  <div>
    <h3>Results:</h3>
    <div class="results" id="resultsBox">
      <div class="result-row">1. <span id="result1"></span></div>
      <div class="result-row">2. <span id="result2"></span></div>
      <div class="result-row">3. <span id="result3"></span></div>
      <div class="result-row">4. <span id="result4"></span></div>
      <div class="result-row">5. <span id="result5"></span></div>
    </div>
  </div>
  
  <div class="box">
    <h3>Your Hand</h3>
    <div class="input-cards" id="handCards">
      <!-- Hand cards will be dynamically added here -->
    </div>
    <button class="button" id="submitButton" onclick="submitCards()" disabled>Submit</button>
  </div>
  
  <div class="ammo-section">
    <img src="https://raw.githubusercontent.com/Delson918/The-Lier/main/gun.png" alt="Gun" class="gun-image">
    <span id="ammoCount">0 / 6</span><br>
    <button class="button" onclick="reload()">Reload</button>
    <button class="button" onclick="shoot()">Shoot</button>
  </div>
</div>

<script>
  let currentSeed = "";
  let currentPlayer = "";
  let ammo = 0;
  let selectedCards = [];
  let submittedCards = [];
  let submissionGroups = [];
  let bulletPosition = -1; // -1 means no bullet loaded
  let currentChamber = 0; // Tracks current cylinder position (0-5)  

  // Card configuration
  const cardImages = {
    // Jokers
    'J1': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/J1.png',
    'J2': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/J2.png',
    'J3': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/J3.png',
    'J4': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/J4.png',
    
    // Queens
    'Q1': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/Q1.png',
    'Q2': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/Q2.png',
    'Q3': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/Q3.png',
    'Q4': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/Q4.png',
    
    // Kings
    'K1': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/K1.png',
    'K2': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/K2.png',
    'K3': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/K3.png',
    'K4': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/K4.png',
    
    // Special cards
    'Joker': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/Joker.png',
    'A': 'https://raw.githubusercontent.com/Delson918/The-Lier/main/A.png'
  };

  // All valid card types
  const validCards = Object.keys(cardImages);

  // Base64 encode with URI-safe characters
  function encodeSeed(seed) {
    return btoa(unescape(encodeURIComponent(seed))
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=+$/, ''));
  }

  // Base64 decode with URI-safe characters
  function decodeSeed(encoded) {
    // Add padding if needed
    encoded = encoded.replace(/-/g, '+').replace(/_/g, '/');
    const pad = encoded.length % 4;
    if (pad) {
      if (pad === 1) {
        throw new Error('Invalid Base64 string');
      }
      encoded += new Array(5-pad).join('=');
    }
    
    try {
      return decodeURIComponent(escape(atob(encoded)));
    } catch (e) {
      return null;
    }
  }

  // Generate deck based on number of players
  function generateDeck(numPlayers) {
    const deck = [];
    
    // Add J, Q, K cards (4 types each) x2 x NOP
    const jqkTypes = ['J', 'Q', 'K'];
    jqkTypes.forEach(type => {
      for (let i = 1; i <= 4; i++) { // 4 types of each
        for (let j = 0; j < 2 * numPlayers; j++) { // x2 x NOP
          deck.push(`${type}${i}`);
        }
      }
    });
    
    // Add Joker cards (NOP / 2 rounded down)
    const jokerCount = Math.floor(numPlayers / 2);
    for (let i = 0; i < jokerCount; i++) {
      deck.push('Joker');
    }
    
    // Add Ace cards (NOP)
    for (let i = 0; i < numPlayers; i++) {
      deck.push('A');
    }
    
    return deck;
  }

  // Shuffle deck using Fisher-Yates algorithm
  function shuffleDeck(deck) {
    for (let i = deck.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [deck[i], deck[j]] = [deck[j], deck[i]];
    }
    return deck;
  }

  // Deal cards to players
  function dealCards(deck, numPlayers) {
    const playersHands = Array(numPlayers).fill().map(() => []);
    let currentPlayer = 0;
    
    // Deal until each player has 5 cards
    for (let i = 0; i < numPlayers * 5; i++) {
      if (deck.length === 0) break; // In case deck is exhausted (shouldn't happen)
      playersHands[currentPlayer].push(deck.pop());
      currentPlayer = (currentPlayer + 1) % numPlayers;
    }
    
    return playersHands;
  }

  // Generate seed from players' hands
  function generateSeedFromHands(playersHands) {
    // Create a string representation of all hands
    const handsString = playersHands.map(hand => hand.join(',')).join('|');
    
    // Create a checksum to verify seed integrity
    const checksum = handsString.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
    
    // Combine with number of players and return
    return `${playersHands.length}-${checksum}-${handsString}`;
  }

  // Parse seed to get players' hands
  function parseSeed(seed) {
    // First decode the Base64
    const decodedSeed = decodeSeed(seed);
    if (!decodedSeed) return null;
    
    const parts = decodedSeed.split('-');
    if (parts.length < 3) return null;
    
    const numPlayers = parseInt(parts[0]);
    const checksum = parseInt(parts[1]);
    const handsString = parts.slice(2).join('-');
    
    // Verify checksum
    const calculatedChecksum = handsString.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
    if (checksum !== calculatedChecksum) return null;
    
    // Parse hands
    const hands = handsString.split('|').map(hand => hand.split(','));
    
    return {
      numPlayers,
      hands
    };
  }

  function generateSeed() {
    const numPlayers = parseInt(document.getElementById("numPlayers").value);
    if (!numPlayers || numPlayers < 2 || numPlayers > 8) {
      alert("Please select number of players between 2-8!");
      return;
    }

    // Generate and shuffle deck
    const deck = shuffleDeck(generateDeck(numPlayers));
    
    // Deal cards to players
    const playersHands = dealCards(deck, numPlayers);
    
    // Generate seed from players' hands and encode it
    const rawSeed = generateSeedFromHands(playersHands);
    currentSeed = encodeSeed(rawSeed);
    document.getElementById("seedOutput").value = currentSeed;
  }

  // Initialize game with specific hand
  function initializeGameWithHand(hand) {
    // Clear previous state
    document.getElementById('handCards').innerHTML = '';
    selectedCards = [];
    submissionGroups = [];
    
    // Clear results (show empty slots)
    for (let i = 1; i <= 5; i++) {
      document.getElementById(`result${i}`).innerHTML = '';
    }
    
    // Reset gun state
    bulletPosition = -1;
    currentChamber = 0;
    ammo = 0;
    updateAmmo();

    // Create hand cards
    hand.forEach((card, index) => {
      const cardElement = document.createElement('div');
      cardElement.className = 'card';
      cardElement.dataset.index = index;
      cardElement.dataset.value = card;
      cardElement.style.backgroundImage = `url(${cardImages[card]})`;
      cardElement.onclick = () => toggleCardSelection(index);
      document.getElementById('handCards').appendChild(cardElement);
    });
    
    function toggleCardSelection(index) {
      console.log('Toggling card selection:', index); // Debug log
      const cardElement = document.querySelector(`.card[data-index="${index}"]`);

      // Skip if card is already submitted
      if (cardElement.classList.contains('submitted')) {
        console.log('Card already submitted, skipping');
        return;
      }

      // Toggle selection
      if (selectedCards.includes(index)) {
        // Deselect
        selectedCards = selectedCards.filter(i => i !== index);
        cardElement.classList.remove('selected');
        console.log('Card deselected:', index);
      } else {
        // Select (but max 3)
        if (selectedCards.length < 3) {
          selectedCards.push(index);
          cardElement.classList.add('selected');
          console.log('Card selected:', index);
        } else {
          console.log('Maximum 3 cards can be selected');
        }
      }

      // Update submit button
      updateSubmitButton();
    }

    function updateSubmitButton() {
      const submitButton = document.getElementById('submitButton');
      submitButton.disabled = selectedCards.length === 0;
      console.log('Submit button updated, disabled:', submitButton.disabled);
    }
  }

  function copySeed() {
    let seed = document.getElementById("seedOutput");
    if (!seed.value) {
      alert("No seed to copy! Generate one first.");
      return;
    }
    seed.select();
    document.execCommand("copy");
    alert("Seed copied: " + seed.value);
  }

  function submitCards() {
      if (selectedCards.length === 0) {
          alert("Please select at least one card to submit!");
          return;
      }

      // Get the hand cards container
      const handCards = document.getElementById('handCards');
      const cards = handCards.querySelectorAll('.card');
  
      // Create a new submission group
      const newSubmission = [];
    
      // Mark selected cards as submitted
      selectedCards.forEach(index => {
          const card = cards[index];
          card.classList.add('submitted');
          card.classList.remove('selected');
          newSubmission.push(card.dataset.value);
      });

      // Add the new submission to our groups
      submissionGroups.push(newSubmission);

      // Update results display
      updateResults();

      // Clear selection
      selectedCards = [];
      document.getElementById('submitButton').disabled = true;
  }

  function updateResults() {
      // Clear all results first
      for (let i = 1; i <= 5; i++) {
          document.getElementById(`result${i}`).innerHTML = '';
      }

      // Display submitted cards
      submissionGroups.forEach((group, groupIndex) => {
          if (groupIndex < 5) { // Only show up to 5 submissions
              const resultSpan = document.getElementById(`result${groupIndex + 1}`);
            
              // Add each card in the group
              group.forEach(card => {
                  const cardElement = document.createElement('div');
                  cardElement.className = 'result-card';
                  cardElement.style.backgroundImage = `url(${cardImages[card]})`;
                  resultSpan.appendChild(cardElement);
              });
          }
      });
  }

  function enterGame() {
    const seedVal = document.getElementById("seedInput").value.trim();
    const playerNum = parseInt(document.getElementById("playerNumber").value);
    
    if (!seedVal) {
      alert("Please enter a seed!");
      return;
    }
    if (!playerNum || playerNum < 1 || playerNum > 8) {
      alert("Please select a valid player position (1-8)!");
      return;
    }
    
    // Parse seed (which will decode the Base64)
    const seedData = parseSeed(seedVal);
    if (!seedData || playerNum > seedData.numPlayers) {
      alert("Invalid seed or player position!");
      return;
    }
    
    currentSeed = seedVal;
    currentPlayer = playerNum;
    document.getElementById("pageA").classList.remove("active");
    document.getElementById("pageB").classList.add("active");
    
    // Initialize game with the specific player's hand
    initializeGameWithHand(seedData.hands[playerNum - 1]);
  }

  function toggleMenu() {
    document.getElementById("quitMenu").classList.toggle("hidden");
  }

  function quitGame() {
    document.getElementById("pageB").classList.remove("active");
    document.getElementById("pageA").classList.add("active");
    document.getElementById("quitMenu").classList.add("hidden");
  }

  function reload() {
      if (currentChamber >= 6) {
          alert("Cylinder is full! Shoot first before reloading.");
          return;
      }
    
      // Randomly place bullet in remaining chambers (currentChamber to 5)
      const remainingChambers = 6 - currentChamber;
      bulletPosition = currentChamber + Math.floor(Math.random() * remainingChambers);
    
      ammo = 6;
      updateAmmo();
      alert("Reloaded! Bullet placed randomly in remaining chambers.");
  }

  function shoot() {
      if (currentChamber >= 6) {
          alert("Cylinder is empty! Reload first.");
          return;
      }
    
      // Check if current chamber has bullet
      if (currentChamber === bulletPosition) {
          alert("BOOM! You're dead!");
          // Reset gun
          bulletPosition = -1;
          currentChamber = 0;
          ammo = 0;
      } else {
          // Advance to next chamber
          currentChamber++;
          ammo--;
      }
    
      updateAmmo();
  }

  function updateAmmo() {
      document.getElementById("ammoCount").innerText = 
          `${currentChamber} / 6 (${bulletPosition >= 0 ? 'Loaded' : 'Empty'})`;
  }
</script>

</body>
</html>
